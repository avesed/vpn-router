# WireGuard Test Clients for DestHash Testing
# Creates multiple WireGuard clients to test ECMP DestHash load balancing
#
# Usage:
#   1. Start vpn-gateway first:
#      docker compose -f docker-compose.local.yml up -d --build
#
#   2. Create WireGuard peer configs via API:
#      curl -X POST http://localhost:36000/api/wg/peers -H "Content-Type: application/json" \
#        -d '{"name": "test-client-1", "allowed_ips": ["10.10.0.2/32"]}'
#      # Repeat for client-2 (10.10.0.3), client-3 (10.10.0.4)
#
#   3. Start clients:
#      docker compose -f docker-compose.wg-clients.yml up -d
#
#   4. Test DestHash - same client to same domain should use same exit:
#      docker exec wg-client-1 curl -s https://youtube.com  # Multiple times
#      docker exec wg-client-2 curl -s https://youtube.com  # May use different exit
#
# Network: 172.30.0.0/24 (bridge)
#   - wg-client-1: 172.30.0.11
#   - wg-client-2: 172.30.0.12
#   - wg-client-3: 172.30.0.13

networks:
  wg-test:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
          gateway: 172.30.0.1

services:
  wg-client-1:
    image: linuxserver/wireguard:latest
    container_name: wg-client-1
    hostname: wg-client-1
    networks:
      wg-test:
        ipv4_address: 172.30.0.11
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
    volumes:
      - ./wg-clients/client-1:/config
    restart: unless-stopped

  wg-client-2:
    image: linuxserver/wireguard:latest
    container_name: wg-client-2
    hostname: wg-client-2
    networks:
      wg-test:
        ipv4_address: 172.30.0.12
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
    volumes:
      - ./wg-clients/client-2:/config
    restart: unless-stopped

  wg-client-3:
    image: linuxserver/wireguard:latest
    container_name: wg-client-3
    hostname: wg-client-3
    networks:
      wg-test:
        ipv4_address: 172.30.0.13
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
    volumes:
      - ./wg-clients/client-3:/config
    restart: unless-stopped
