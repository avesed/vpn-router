# =============================================================================
# VPN Router Environment Variables
# =============================================================================
# Copy this file to .env and customize as needed.
# Default values are shown after the = sign.
#
# Usage:
#   cp example.env .env
#   docker compose up -d
# =============================================================================

# =============================================================================
# GENERAL SETTINGS
# =============================================================================

# Timezone (IANA format)
TZ=America/New_York

# Disable IPv6 (recommended for most setups)
DISABLE_IPV6=1

# =============================================================================
# WEB & API
# =============================================================================

# Web UI + API port
WEB_PORT=36000

# FastAPI internal port (usually not exposed)
API_HOST=0.0.0.0

# =============================================================================
# WIREGUARD INGRESS
# =============================================================================

# WireGuard UDP listen port
WG_LISTEN_PORT=36100

# WireGuard ingress subnet (clients get IPs from this range)
WG_INGRESS_SUBNET=10.25.0.1/24

# Public endpoint for WireGuard (shown in peer configs)
# Leave empty to auto-detect
WG_SERVER_ENDPOINT=

# =============================================================================
# PIA (Private Internet Access)
# =============================================================================

# PIA credentials (required for PIA egress)
PIA_USERNAME=
PIA_PASSWORD=

# =============================================================================
# RUST ROUTER (DATA PLANE)
# =============================================================================

# Enable rust-router data plane (pure userspace implementation)
# When true: Uses boringtun for WireGuard, ipstack for TCP/IP bridging
# When false: Uses kernel WireGuard (requires wg-quick/wg)
USE_RUST_ROUTER=true

# Use userspace WireGuard (boringtun) instead of kernel module
# Required when kernel WireGuard is not available (e.g., Docker without host network)
USERSPACE_WG=true

# IPC socket path for rust-router control
RUST_ROUTER_IPC_SOCKET=/run/rust-router.sock

# Listen address for rust-router
RUST_ROUTER_LISTEN_ADDR=0.0.0.0

# Maximum concurrent connections
RUST_ROUTER_MAX_CONNECTIONS=10000

# WireGuard private key (auto-generated if not set)
RUST_ROUTER_WG_PRIVATE_KEY=

# WireGuard subnet for rust-router
RUST_ROUTER_WG_SUBNET=10.25.0.1/24

# Node tag for multi-node peering
RUST_ROUTER_NODE_TAG=default

# WireGuard local IP for ingress
RUST_ROUTER_WG_LOCAL_IP=10.25.0.1

# Enable batch I/O for WireGuard (improves throughput)
RUST_ROUTER_WG_BATCH_IO=true

# Enable SOCKS5 inbound listener
RUST_ROUTER_SOCKS5_INBOUND=false

# SOCKS5 inbound port
RUST_ROUTER_SOCKS5_INBOUND_PORT=1080

# Enable TPROXY mode (requires iptables setup)
RUST_ROUTER_TPROXY_ENABLED=false

# =============================================================================
# IPSTACK PERFORMANCE TUNING
# =============================================================================

# Number of ipstack shards for parallel processing
# Default: cores/2, clamped to [2, 16]
# For single-core VPS, use 2
IPSTACK_SHARDS=

# TCP buffer size in KB (8-256)
# Default: 64KB (high throughput)
# For 1GB VPS: use 16KB to reduce memory
IPSTACK_TCP_BUFFER_KB=64

# Maximum concurrent sessions
# Default: 10000
# For 1GB VPS: use 2000-3000 to reduce memory
IPSTACK_MAX_SESSIONS=10000

# Maximum unacknowledged bytes / TCP receive buffer (affects BOTH directions!)
# CRITICAL for throughput! This is the Bandwidth-Delay Product limit.
#
# This setting controls:
#   - max_unacked_bytes: Limits data sent but not ACKed (DOWNLOAD speed)
#   - read_buffer_size: TCP receive window advertised to peer (UPLOAD speed)
#
# Default: 256KB - supports 100 Mbps @ 20ms RTT
# Formula: max_throughput = buffer_size / RTT
#   256KB @ 20ms = 100 Mbps
#   256KB @ 100ms = 20 Mbps
#   1MB @ 100ms = 80 Mbps
# For high throughput: use 512-1024KB
# For 1GB VPS: use 64KB to reduce memory
IPSTACK_MAX_UNACK_KB=256

# =============================================================================
# LOW-MEMORY VPS CONFIGURATION (1GB RAM)
# =============================================================================
# Uncomment these for low-memory systems:
# IPSTACK_TCP_BUFFER_KB=16
# IPSTACK_MAX_SESSIONS=2000
# IPSTACK_MAX_UNACK_KB=64
# IPSTACK_SHARDS=2
#
# Memory estimate: max_sessions × (buffer_size × 3 + max_unack × 2) + 50MB base
# Default (64KB buffer, 256KB unack, 10K): ~7GB peak
# Conservative (16KB buffer, 64KB unack, 2K): ~300MB peak

# =============================================================================
# HIGH-THROUGHPUT CONFIGURATION (1+ Gbps)
# =============================================================================
# Uncomment these for high-bandwidth servers:
# IPSTACK_MAX_UNACK_KB=1024
# IPSTACK_TCP_BUFFER_KB=128

# =============================================================================
# DNS CONFIGURATION
# =============================================================================

# Enable rust-router DNS server
RUST_ROUTER_DNS_ENABLED=true

# DNS listen port
RUST_ROUTER_DNS_PORT=7853

# =============================================================================
# WIREGUARD HANDSHAKE TUNING
# =============================================================================

# Maximum handshake retries
WG_HANDSHAKE_MAX_RETRIES=5

# Initial backoff in milliseconds
WG_HANDSHAKE_INITIAL_BACKOFF_MS=1000

# Maximum backoff in milliseconds
WG_HANDSHAKE_MAX_BACKOFF_MS=30000

# Backoff multiplier (exponential)
WG_HANDSHAKE_BACKOFF_MULTIPLIER=2

# Handshake timeout in seconds
WG_HANDSHAKE_TIMEOUT_SECS=60

# =============================================================================
# LOGGING
# =============================================================================

# Python scripts log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# Rust router log level (supports fine-grained control)
# Simple: trace, debug, info, warn, error
# Fine-grained: rust_router=debug,hyper=warn,tokio=info
RUST_LOG=info

# Alternative: Override rust-router log level (takes precedence over config file)
RUST_ROUTER_LOG_LEVEL=

# Enable debug mode for Python scripts
DEBUG=false

# =============================================================================
# DATABASE & ENCRYPTION
# =============================================================================

# SQLCipher encryption key (auto-generated if not set)
# IMPORTANT: Back up this key! Data is unrecoverable without it.
SQLCIPHER_KEY=

# Database paths
GEODATA_DB_PATH=/etc/sing-box/geoip-geodata.db
USER_DB_PATH=/etc/sing-box/user-config.db

# =============================================================================
# CONFIG FILE PATHS
# =============================================================================

# Sing-box configuration paths
SING_BOX_CONFIG=/etc/sing-box/sing-box.json
SING_BOX_BASE_CONFIG=/etc/sing-box/sing-box.json
SING_BOX_GENERATED_CONFIG=/etc/sing-box/sing-box.generated.json

# PIA profiles
PIA_PROFILES_FILE=/etc/sing-box/pia/profiles.yml
PIA_PROFILES_OUTPUT=/etc/sing-box/pia-profiles.json

# Custom rules
CUSTOM_RULES_FILE=/etc/sing-box/custom-rules.json

# Domain/IP catalogs
DOMAIN_CATALOG_FILE=/etc/sing-box/domain-catalog.json
DOMAIN_LIST_DIR=/etc/sing-box/domain-list/data
IP_CATALOG_FILE=/etc/sing-box/ip-catalog.json
GEOIP_CATALOG_FILE=/etc/sing-box/geoip-catalog.json
GEOIP_DIR=/etc/sing-box/geoip
IP_LIST_DIR=/etc/sing-box/ip-list/country

# Settings and custom categories
SETTINGS_FILE=/etc/sing-box/settings.json
CUSTOM_CATEGORY_ITEMS_FILE=/etc/sing-box/custom-category-items.json

# WireGuard config
WG_CONFIG_PATH=/etc/sing-box/wireguard/server.json

# Rulesets directory
RULESETS_DIR=/etc/sing-box/rulesets

# Encryption key path
ENCRYPTION_KEY_PATH=/etc/sing-box/encryption.key

# =============================================================================
# PORT RANGES
# =============================================================================

# Peer tunnel port range (for multi-node peering)
PEER_TUNNEL_PORT_MIN=36200
PEER_TUNNEL_PORT_MAX=36299

# V2Ray egress SOCKS5 port start
V2RAY_SOCKS_PORT_BASE=37101
V2RAY_EGRESS_SOCKS_PORT_START=37101

# Peer Xray SOCKS port start
PEER_XRAY_SOCKS_PORT_START=37201

# Peer inbound port start
PEER_INBOUND_PORT_START=36500

# WARP MASQUE port start
WARP_MASQUE_PORT_BASE=38001

# TPROXY listen address
TPROXY_LISTEN_ADDR=0.0.0.0

# =============================================================================
# MULTI-NODE PEERING
# =============================================================================

# Node ID for multi-node setup (auto-generated if not set)
VPN_ROUTER_NODE_ID=

# =============================================================================
# HEALTH CHECK
# =============================================================================

# Rust router socket path for health checks
RUST_ROUTER_SOCKET=/run/rust-router.sock
