# Macvlan network mode - container gets its own IP address
# Usage: docker compose -f docker-compose.macvlan.yml up -d
#
# Prerequisites:
#   1. Create macvlan network first (run once):
#      docker network create -d macvlan \
#        --subnet=10.1.1.0/24 \
#        --gateway=10.1.1.1 \
#        -o parent=eth0 \
#        macvlan_lan
#
#   2. Adjust subnet/gateway/parent interface to match your network
#
# Advantages:
#   - Full network isolation (wg-ingress not visible on host)
#   - Container has its own IP (e.g., 10.1.1.100)
#   - No port conflicts with host
#   - Better security
#
# Note: Host cannot directly communicate with macvlan container.
#       Access from other devices on the network works fine.

services:
  vpn-gateway:
    container_name: vpn-gateway
    image: ghcr.io/avesed/vpn-router:latest
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    environment:
      - TZ=America/New_York
      - DISABLE_IPV6=1
      - PIA_USERNAME=${PIA_USERNAME:-}
      - PIA_PASSWORD=${PIA_PASSWORD:-}
      - WG_SERVER_ENDPOINT=${WG_SERVER_ENDPOINT:-}
      - WEB_PORT=${WEB_PORT:-36000}
      - WG_LISTEN_PORT=${WG_LISTEN_PORT:-36100}
    networks:
      macvlan_lan:
        ipv4_address: 10.1.1.100  # Adjust to your network
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ./config:/etc/sing-box
    restart: unless-stopped

networks:
  macvlan_lan:
    external: true
