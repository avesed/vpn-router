services:
  vpn-gateway:
    container_name: vpn-gateway
    image: ghcr.io/avesed/vpn-router:latest
    # SECURITY: privileged mode is required for:
    # - Kernel WireGuard interface creation (ip link add type wireguard)
    # - TPROXY iptables rules (requires NET_ADMIN + mangle table access)
    # - sysctl modifications (ip_forward, rp_filter)
    # This cannot be replaced with cap_add due to TPROXY requirements
    privileged: true
    network_mode: host
    # Graceful shutdown timeout (allow cleanup of WireGuard interfaces)
    stop_grace_period: 30s
    # Required for kernel WireGuard + TPROXY
    # security_opt disables seccomp/apparmor restrictions needed for TPROXY
    #cap_add:
    #  - NET_ADMIN
    #  - NET_RAW
    #security_opt:
    #  - seccomp:unconfined
    #  - apparmor:unconfined
    #sysctls:
    #  - net.ipv4.ip_forward=1
    #  - net.ipv4.conf.all.src_valid_mark=1
    #  - net.ipv4.ip_nonlocal_bind=1
    #  - net.ipv4.conf.all.rp_filter=0
    #  - net.ipv4.conf.default.rp_filter=0
    #  - net.ipv4.conf.lo.rp_filter=0
    environment:
      - TZ=America/New_York
      - DISABLE_IPV6=1
      - PIA_USERNAME=${PIA_USERNAME:-}
      - PIA_PASSWORD=${PIA_PASSWORD:-}
      - WG_SERVER_ENDPOINT=${WG_SERVER_ENDPOINT:-}
      - WEB_PORT=${WEB_PORT:-36000}
      - WG_LISTEN_PORT=${WG_LISTEN_PORT:-36100}
      # ============ Global Logging Configuration ============
      # Python scripts: DEBUG, INFO, WARNING, ERROR, CRITICAL
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Rust router (supports fine-grained control):
      #   Simple: trace, debug, info, warn, error
      #   Fine-grained: rust_router=debug,hyper=warn,tokio=info
      - RUST_LOG=${RUST_LOG:-info}
      # Alternative: RUST_ROUTER_LOG_LEVEL (overrides config file)
      - RUST_ROUTER_LOG_LEVEL=${RUST_ROUTER_LOG_LEVEL:-}
    #ports:
    #  - "${WEB_PORT:-36000}:${WEB_PORT:-36000}"           # Web UI
    #  - "${WG_LISTEN_PORT:-36100}:${WG_LISTEN_PORT:-36100}/udp"  # WireGuard
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ./config:/etc/sing-box
    # H5: 生产日志配置 - 防止日志无限增长
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    # Resource limits for production stability
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    restart: unless-stopped
    # Explicit healthcheck (matches Dockerfile HEALTHCHECK)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
