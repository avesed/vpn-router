services:
  vpn-gateway:
    container_name: vpn-gateway
    build: .
    # image: ghcr.io/avesed/vpn-router:latest
    privileged: true
    network_mode: host
    # sysctls 在 host 网络模式下不可用，需要在宿主机上设置：
    # sudo sysctl -w net.ipv4.ip_forward=1
    environment:
      - TZ=Asia/Shanghai
      - DISABLE_IPV6=1
      - PIA_USERNAME=${PIA_USERNAME:-}
      - PIA_PASSWORD=${PIA_PASSWORD:-}
      - WG_SERVER_ENDPOINT=${WG_SERVER_ENDPOINT:-}
      - WEB_PORT=${WEB_PORT:-36000}
      - WG_LISTEN_PORT=${WG_LISTEN_PORT:-36100}
    # network_mode: host - 不需要端口映射，直接使用宿主机端口
    # 访问 Web UI: http://localhost:${WEB_PORT:-36000}
    # WireGuard: ${WG_LISTEN_PORT:-36100}/udp
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ./config:/etc/sing-box
      - ./scripts/api_server.py:/usr/local/bin/api_server.py:ro
      - ./scripts/db_helper.py:/usr/local/bin/db_helper.py:ro
      - ./scripts/render_singbox.py:/usr/local/bin/render_singbox.py:ro
      - ./scripts/convert_adblock.py:/usr/local/bin/convert_adblock.py:ro
      - ./scripts/entrypoint.sh:/usr/local/bin/entrypoint.sh:ro
      - ./scripts/init_user_db.py:/usr/local/bin/init_user_db.py:ro
    restart: unless-stopped
